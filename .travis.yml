services:
  - docker

language: go

git:
  submodules: true
  quiet: true

install:
  - curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
  - chmod +x skaffold
  - sudo mv skaffold /usr/local/bin

jobs:
  include:
    - stage: Pre-build
      if: fork = false # We can only use encrypted ENV vars from trusted source (non-forks)
      name: Bake dockerized tooling
      script:
        - echo "$DOCKER_ACCESS_TOKEN" | docker login --username "$DOCKER_USERNAME" --password-stdin
        - make bake-tooling
    - stage: Build
      name: Documentation generation
      script:
        - make docs-generate
      deploy:
        provider: pages
        skip_cleanup: true
        github_token: $GITHUB_TOKEN_DOCS
        local_dir: docs/public
        repo: trisacrypto/trisacrypto.github.io
        target_branch: master
        keep_history: false
        committer_from_gh: true
        on:
          branch: master
    - name: Development certificate generation
      script:
        - make pki-dev-init

notifications:
  email: false

branches:
  only:
    - master
